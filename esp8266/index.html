<!doctype html><html lang=en class="js csstransforms3d">
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=generator content="Hugo 0.91.2">
<meta name=description content>
<link rel=icon href=/images/favicon.png type=image/png>
<title>Program the ESP8266 :: RHTE 2023 Edge Lab</title>
<link href=/css/nucleus.css?1673368128 rel=stylesheet>
<link href=/css/fontawesome-all.min.css?1673368128 rel=stylesheet>
<link href=/css/hybrid.css?1673368128 rel=stylesheet>
<link href=/css/featherlight.min.css?1673368128 rel=stylesheet>
<link href=/css/perfect-scrollbar.min.css?1673368128 rel=stylesheet>
<link href=/css/auto-complete.css?1673368128 rel=stylesheet>
<link href=/css/atom-one-dark-reasonable.css?1673368128 rel=stylesheet>
<link href=/css/theme.css?1673368128 rel=stylesheet>
<link href=/css/tabs.css?1673368128 rel=stylesheet>
<link href=/css/hugo-theme.css?1673368128 rel=stylesheet>
<link href=/css/theme-red.css?1673368128 rel=stylesheet>
<script src=/js/jquery-3.3.1.min.js?1673368128></script>
<style>:root #header+#content>#left>#rlblock_left{display:none!important}</style>
</head>
<body data-url=/esp8266/>
<nav id=sidebar class=showVisitedLinks>
<div id=header-wrapper>
<div id=header>
<img src=/images/logo.svg>
</div>
<div class=searchbox>
<label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span>
</div>
<script type=text/javascript src=/js/lunr.min.js?1673368128></script>
<script type=text/javascript src=/js/auto-complete.js?1673368128></script>
<script type=text/javascript>var baseurl="https://RHTE-2023-Edge-Lab.github.io/"</script>
<script type=text/javascript src=/js/search.js?1673368128></script>
</div>
<section id=homelinks>
<ul>
<li>
<a class=padding href=/><i class="fas fa-home"></i> Home</a>
</li>
</ul>
</section>
<div class=highlightable>
<ul class=topics>
<li data-nav-id=/use-case/ title="Use Case" class=dd-item>
<a href=/use-case/>
<b>1. </b>Use Case
<i class="fas fa-check read-icon"></i>
</a>
<ul>
<li data-nav-id=/use-case/goal/ title=Goal class=dd-item>
<a href=/use-case/goal/>
Goal
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/use-case/organization/ title=Organization class=dd-item>
<a href=/use-case/organization/>
Organization
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/use-case/ice-breaker/ title="Ice Breaker" class=dd-item>
<a href=/use-case/ice-breaker/>
Ice Breaker
<i class="fas fa-check read-icon"></i>
</a>
</li>
</ul>
</li>
<li data-nav-id=/pre-requisites/ title="Pre Requisites" class=dd-item>
<a href=/pre-requisites/>
<b>2. </b>Pre Requisites
<i class="fas fa-check read-icon"></i>
</a>
<ul>
<li data-nav-id=/pre-requisites/general/ title=General class=dd-item>
<a href=/pre-requisites/general/>
General
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/pre-requisites/linux/ title=Linux class=dd-item>
<a href=/pre-requisites/linux/>
Linux
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/pre-requisites/macos/ title=MacOS class=dd-item>
<a href=/pre-requisites/macos/>
MacOS
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/pre-requisites/windows/ title=Windows class=dd-item>
<a href=/pre-requisites/windows/>
Windows
<i class="fas fa-check read-icon"></i>
</a>
</li>
</ul>
</li>
<li data-nav-id=/mqtt-broker/ title="MQTT Broker" class=dd-item>
<a href=/mqtt-broker/>
<b>A & B. </b>MQTT Broker
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/esp8266/ title="Program the ESP8266" class="dd-item
parent
active">
<a href=/esp8266/>
<b>A & B. </b>Program the ESP8266
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/kafka-broker/ title="Kafka Broker" class=dd-item>
<a href=/kafka-broker/>
<b>C. </b>Kafka Broker
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/camel-k/ title="Camel-K Integration" class=dd-item>
<a href=/camel-k/>
<b>C. </b>Camel-K Integration
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/mirromaker2/ title=MirrorMaker2 class=dd-item>
<a href=/mirromaker2/>
<b>C. </b>MirrorMaker2
<i class="fas fa-check read-icon"></i>
</a>
</li>
<li data-nav-id=/testing/ title=Testing class=dd-item>
<a href=/testing/>
<b>A,B & C. </b>Testing
<i class="fas fa-check read-icon"></i>
</a>
</li>
</ul>
<section id=prefooter>
<hr>
<ul>
<li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i> Clear History</a></li>
</ul>
</section>
<section id=footer>
<p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a> from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p>
</section>
</div>
</nav>
<section id=body>
<div id=overlay></div>
<div class="padding highlightable">
<div>
<div id=top-bar>
<div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb>
<span id=sidebar-toggle-span>
<a href=# id=sidebar-toggle data-sidebar-toggle>
<i class="fas fa-bars"></i>
</a>
</span>
<span class=links>
<a href=/>Welcome</a> > Program the ESP8266
</span>
</div>
</div>
</div>
<div id=head-tags>
</div>
<div id=chapter>
<div id=body-inner>
<h1 id=program-the-esp8266>Program the ESP8266</h1>
<h2 id=0-fix-permissions-on-devttyusb0>0. Fix permissions on /dev/ttyUSB0</h2>
<p>The /dev/ttyUSB0 device belongs to the &ldquo;dialout&rdquo; group. Therefore, your user should belong to this group to configure the ESP8266. Run the following command and restart your session to fix the permissions.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo usermod -a -G dialout <span style=color:#66d9ef>$(</span>id -un<span style=color:#66d9ef>)</span>
</code></pre></div><h2 id=1-duo-a--b---connect-your-esp8266>1. Duo A & B - Connect your ESP8266</h2>
<p>Connect ESP8266 to your computer via USB connector.</p>
<p><img src=/images/esp8266-usb.jpeg alt="ESP8266 USB"></p>
<h2 id=2-duo-a--b---create-new-project-in-plaformio-vscode-plugin>2. Duo A & B - Create new project in PlaformIO VSCode plugin</h2>
<p><img src=/images/platformIO-home.png alt="PlatformIO Home"></p>
<p><img src=/images/platformIO-new-project1.png alt="PlatformIO New project"></p>
<p><img src=/images/platformIO-new-project2.png alt="PlatformIO New project"></p>
<p><img src=/images/platformIO-new-project3.png alt="PlatformIO New project"></p>
<h2 id=3-duo-a--b---add-specific-libraries-in-your-new-create-project>3. Duo A & B - Add specific libraries in your new create project</h2>
<ul>
<li>
<p>Library <strong>MFRC522 by Miguel Andr√© Balboa</strong> : Arduino RFID Library for MFRC522 (SPI). Read/Write a RFID Card or Tag using the ISO/IEC 14443A/MIFARE interface.</p>
</li>
<li>
<p>Library <strong>PubSubClient by Nick O&rsquo;Leary</strong> : A client library for MQTT messaging. MQTT is a lightweight messaging protocol ideal for small devices. This library allows you to send and receive MQTT messages. It supports the latest MQTT 3.1.1 protocol and can be configured to use the older MQTT 3.1 if needed. It supports all Arduino Ethernet Client compatible hardware, including the Intel Galileo/Edison, ESP8266 and TI CC3000.</p>
</li>
</ul>
<p><img src=/images/platformIO-add-library1.png alt="PlatformIO add library"></p>
<p><img src=/images/platformIO-add-library2.png alt="PlatformIO add library"></p>
<p><img src=/images/platformIO-add-library3.png alt="PlatformIO add library"></p>
<p><img src=/images/platformIO-add-library4.png alt="PlatformIO add library"></p>
<p><img src=/images/platformIO-add-library5.png alt="PlatformIO add library"></p>
<h2 id=4-duo-a---deploy-build-and-upload-code-on-your-esp8266-dedicated-for-entrence-packets>4. Duo A - Deploy, build and upload code on your ESP8266 dedicated for entrence packets</h2>
<h3 id=adapt-this-code-in-the-srcmaincpp-file-of-your-plarformio-project>Adapt this code in the src/main.cpp file of your plarformIO project</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e>#include &lt;Arduino.h&gt;</span>
<span style=color:#75715e>#include &lt;SPI.h&gt;</span>
<span style=color:#75715e>#include &lt;MFRC522.h&gt;</span>
<span style=color:#75715e>#include &lt;ESP8266WiFi.h&gt;</span>
<span style=color:#75715e>#include &lt;PubSubClient.h&gt;</span>

MFRC522 mfrc522;
WiFiClient espClient;
PubSubClient client<span style=color:#f92672>(</span>espClient<span style=color:#f92672>)</span>;

//WIFI
const char* ssid <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;wifi_ssid&gt;&#34;</span>;  //  SSID Wifi
const char* password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;wifi_password&gt;&#34;</span>;  //mot de passe Wifi


// MQTT Broker
const char *mqtt_broker <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;AWS LB address for MQTT service&gt;&#34;</span>;
const char *mqtt_topic <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;esp8266-in&#34;</span>;
const char *mqtt_username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;MQTT user&gt;&#34;</span>;
const char *mqtt_password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;MQTT password&gt;&#34;</span>;
const int mqtt_port <span style=color:#f92672>=</span> &lt;MQTT port&gt;;

void setup<span style=color:#f92672>()</span>
<span style=color:#f92672>{</span>
  Serial.begin<span style=color:#f92672>(</span>9600<span style=color:#f92672>)</span>;     // Initialize serial communications with the PC
  <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>!Serial<span style=color:#f92672>)</span>;        // Do nothing <span style=color:#66d9ef>if</span> no serial port is opened <span style=color:#f92672>(</span>added <span style=color:#66d9ef>for</span> Arduinos based on ATMEGA32U4<span style=color:#f92672>)</span>
  Serial.println<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Initializing...&#34;</span><span style=color:#f92672>)</span>;
  SPI.begin<span style=color:#f92672>()</span>;            // Init SPI bus
  mfrc522.PCD_Init<span style=color:#f92672>()</span>;     // Init MFRC522
  delay<span style=color:#f92672>(</span>4<span style=color:#f92672>)</span>;               // Optional delay.

  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>!mfrc522.PCD_PerformSelfTest<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
    Serial.println<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;MFRC522 not ready !&#34;</span><span style=color:#f92672>)</span>;
  <span style=color:#f92672>}</span>
  Serial.println<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Ready !&#34;</span><span style=color:#f92672>)</span>;

  // Wifi initialization
  WiFi.mode<span style=color:#f92672>(</span>WIFI_STA<span style=color:#f92672>)</span>;
  WiFi.begin<span style=color:#f92672>(</span>ssid, password<span style=color:#f92672>)</span>;
  Serial.print<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Connecting to Wifi...&#34;</span><span style=color:#f92672>)</span>;
  <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>WiFi.status<span style=color:#f92672>()</span> !<span style=color:#f92672>=</span> WL_CONNECTED<span style=color:#f92672>)</span>
  <span style=color:#f92672>{</span>
    delay<span style=color:#f92672>(</span>500<span style=color:#f92672>)</span>;
    Serial.print<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.&#34;</span><span style=color:#f92672>)</span>;
  <span style=color:#f92672>}</span>
  Serial.println<span style=color:#f92672>()</span>;
  Serial.print<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Connected, IP address: &#34;</span><span style=color:#f92672>)</span>;
  Serial.println<span style=color:#f92672>(</span>WiFi.localIP<span style=color:#f92672>())</span>;
  randomSeed<span style=color:#f92672>(</span>micros<span style=color:#f92672>())</span>;

  // MQTT initialization
  client.setServer<span style=color:#f92672>(</span>mqtt_broker, mqtt_port<span style=color:#f92672>)</span>;
<span style=color:#f92672>}</span>

void reconnect<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
  // Loop <span style=color:#66d9ef>until</span> we<span style=color:#960050;background-color:#1e0010>&#39;</span>re reconnected
  <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>!client.connected<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
    Serial.print<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Attempting MQTT connection...&#34;</span><span style=color:#f92672>)</span>;
    // Create a random client ID
    String clientId <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ESP8266Client-&#34;</span>;
    clientId <span style=color:#f92672>+=</span> String<span style=color:#f92672>(</span>random<span style=color:#f92672>(</span>0xffff<span style=color:#f92672>)</span>, HEX<span style=color:#f92672>)</span>;
    // Attempt to connect
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>client.connect<span style=color:#f92672>(</span>clientId.c_str<span style=color:#f92672>()</span>, mqtt_username, mqtt_password<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
      Serial.println<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;connected to MQTT Broker&#34;</span><span style=color:#f92672>)</span>;
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
      Serial.print<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;failed, rc=&#34;</span><span style=color:#f92672>)</span>;
      Serial.print<span style=color:#f92672>(</span>client.state<span style=color:#f92672>())</span>;
      Serial.println<span style=color:#f92672>(</span><span style=color:#e6db74>&#34; try again in 5 seconds&#34;</span><span style=color:#f92672>)</span>;
      // Wait <span style=color:#ae81ff>5</span> seconds before retrying
      delay<span style=color:#f92672>(</span>5000<span style=color:#f92672>)</span>;
    <span style=color:#f92672>}</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>

void loop<span style=color:#f92672>()</span>
<span style=color:#f92672>{</span>
  // MQTT connection to the broker + protocol handling
  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>!client.connected<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
    reconnect<span style=color:#f92672>()</span>;
  <span style=color:#f92672>}</span>
  client.loop<span style=color:#f92672>()</span>;

  // Reset the loop <span style=color:#66d9ef>if</span> no new card present on the sensor/reader. This saves the entire process when idle.
  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span> ! mfrc522.PICC_IsNewCardPresent<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>return</span>;
  <span style=color:#f92672>}</span>

  // Select one of the cards
  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span> ! mfrc522.PICC_ReadCardSerial<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>return</span>;
  <span style=color:#f92672>}</span>

  // Compute and print UID
  char uid<span style=color:#f92672>[</span>30<span style=color:#f92672>]</span>;
  char * buffer <span style=color:#f92672>=</span> uid;
  <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>byte i <span style=color:#f92672>=</span> 0; i &lt; mfrc522.uid.size; i++<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    int n <span style=color:#f92672>=</span> sprintf<span style=color:#f92672>(</span>buffer, <span style=color:#e6db74>&#34;%s%02x&#34;</span>, i &gt; <span style=color:#ae81ff>0</span> ? <span style=color:#e6db74>&#34;:&#34;</span> : <span style=color:#e6db74>&#34;&#34;</span>, mfrc522.uid.uidByte<span style=color:#f92672>[</span>i<span style=color:#f92672>])</span>;
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>n &gt; 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
      buffer <span style=color:#f92672>+=</span> n;
    <span style=color:#f92672>}</span>
  <span style=color:#f92672>}</span>
  Serial.println<span style=color:#f92672>(</span>uid<span style=color:#f92672>)</span>;
  client.publish<span style=color:#f92672>(</span>mqtt_topic, uid<span style=color:#f92672>)</span>;
  delay<span style=color:#f92672>(</span>500<span style=color:#f92672>)</span>;
<span style=color:#f92672>}</span>
</code></pre></div><h3 id=compile-your-code>Compile your code</h3>
<p><img src=/images/platformIO-esp-build.png alt="PlatformIO build"></p>
<h3 id=flash-your-esp8266-with-your-code>Flash your ESP8266 with your code</h3>
<p><img src=/images/platformIO-esp-write.png alt="PlatformIO write"></p>
<h3 id=connect-to-your-esp8266-console>Connect to your ESP8266 console</h3>
<p><img src=/images/platformIO-esp-console.png alt="PlatformIO console"></p>
<h3 id=result>Result</h3>
<p><img src=/images/platformIO-esp-test.png alt="PlatformIO result"></p>
<h2 id=4-duo-b---deploy-build-and-upload-code-on-your-esp8266-dedicated-for-output-packets>4. Duo B - Deploy, build and upload code on your ESP8266 dedicated for output packets</h2>
<h3 id=adapt-this-code-in-the-srcmaincpp-file-of-your-plarformio-project-1>Adapt this code in the src/main.cpp file of your plarformIO project</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e>#include &lt;Arduino.h&gt;</span>
<span style=color:#75715e>#include &lt;SPI.h&gt;</span>
<span style=color:#75715e>#include &lt;MFRC522.h&gt;</span>
<span style=color:#75715e>#include &lt;ESP8266WiFi.h&gt;</span>
<span style=color:#75715e>#include &lt;PubSubClient.h&gt;</span>

MFRC522 mfrc522;
WiFiClient espClient;
PubSubClient client<span style=color:#f92672>(</span>espClient<span style=color:#f92672>)</span>;

//WIFI
const char* ssid <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;wifi_ssid&gt;&#34;</span>;  //  SSID Wifi
const char* password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;wifi_password&gt;&#34;</span>;  //mot de passe Wifi


// MQTT Broker
const char *mqtt_broker <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;AWS LB address for MQTT service&gt;&#34;</span>;
const char *mqtt_topic <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;esp8266-out&#34;</span>;
const char *mqtt_username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;MQTT user&gt;&#34;</span>;
const char *mqtt_password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;MQTT password&gt;&#34;</span>;
const int mqtt_port <span style=color:#f92672>=</span> &lt;MQTT port&gt;;

void setup<span style=color:#f92672>()</span>
<span style=color:#f92672>{</span>
  Serial.begin<span style=color:#f92672>(</span>9600<span style=color:#f92672>)</span>;     // Initialize serial communications with the PC
  <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>!Serial<span style=color:#f92672>)</span>;        // Do nothing <span style=color:#66d9ef>if</span> no serial port is opened <span style=color:#f92672>(</span>added <span style=color:#66d9ef>for</span> Arduinos based on ATMEGA32U4<span style=color:#f92672>)</span>
  Serial.println<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Initializing...&#34;</span><span style=color:#f92672>)</span>;
  SPI.begin<span style=color:#f92672>()</span>;            // Init SPI bus
  mfrc522.PCD_Init<span style=color:#f92672>()</span>;     // Init MFRC522
  delay<span style=color:#f92672>(</span>4<span style=color:#f92672>)</span>;               // Optional delay.

  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>!mfrc522.PCD_PerformSelfTest<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
    Serial.println<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;MFRC522 not ready !&#34;</span><span style=color:#f92672>)</span>;
  <span style=color:#f92672>}</span>
  Serial.println<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Ready !&#34;</span><span style=color:#f92672>)</span>;

  // Wifi initialization
  WiFi.mode<span style=color:#f92672>(</span>WIFI_STA<span style=color:#f92672>)</span>;
  WiFi.begin<span style=color:#f92672>(</span>ssid, password<span style=color:#f92672>)</span>;
  Serial.print<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Connecting to Wifi...&#34;</span><span style=color:#f92672>)</span>;
  <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>WiFi.status<span style=color:#f92672>()</span> !<span style=color:#f92672>=</span> WL_CONNECTED<span style=color:#f92672>)</span>
  <span style=color:#f92672>{</span>
    delay<span style=color:#f92672>(</span>500<span style=color:#f92672>)</span>;
    Serial.print<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.&#34;</span><span style=color:#f92672>)</span>;
  <span style=color:#f92672>}</span>
  Serial.println<span style=color:#f92672>()</span>;
  Serial.print<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Connected, IP address: &#34;</span><span style=color:#f92672>)</span>;
  Serial.println<span style=color:#f92672>(</span>WiFi.localIP<span style=color:#f92672>())</span>;
  randomSeed<span style=color:#f92672>(</span>micros<span style=color:#f92672>())</span>;

  // MQTT initialization
  client.setServer<span style=color:#f92672>(</span>mqtt_broker, mqtt_port<span style=color:#f92672>)</span>;
<span style=color:#f92672>}</span>

void reconnect<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
  // Loop <span style=color:#66d9ef>until</span> we<span style=color:#960050;background-color:#1e0010>&#39;</span>re reconnected
  <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>!client.connected<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
    Serial.print<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Attempting MQTT connection...&#34;</span><span style=color:#f92672>)</span>;
    // Create a random client ID
    String clientId <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ESP8266Client-&#34;</span>;
    clientId <span style=color:#f92672>+=</span> String<span style=color:#f92672>(</span>random<span style=color:#f92672>(</span>0xffff<span style=color:#f92672>)</span>, HEX<span style=color:#f92672>)</span>;
    // Attempt to connect
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>client.connect<span style=color:#f92672>(</span>clientId.c_str<span style=color:#f92672>()</span>, mqtt_username, mqtt_password<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
      Serial.println<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;connected to MQTT Broker&#34;</span><span style=color:#f92672>)</span>;
    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
      Serial.print<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;failed, rc=&#34;</span><span style=color:#f92672>)</span>;
      Serial.print<span style=color:#f92672>(</span>client.state<span style=color:#f92672>())</span>;
      Serial.println<span style=color:#f92672>(</span><span style=color:#e6db74>&#34; try again in 5 seconds&#34;</span><span style=color:#f92672>)</span>;
      // Wait <span style=color:#ae81ff>5</span> seconds before retrying
      delay<span style=color:#f92672>(</span>5000<span style=color:#f92672>)</span>;
    <span style=color:#f92672>}</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>

void loop<span style=color:#f92672>()</span>
<span style=color:#f92672>{</span>
  // MQTT connection to the broker + protocol handling
  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>!client.connected<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
    reconnect<span style=color:#f92672>()</span>;
  <span style=color:#f92672>}</span>
  client.loop<span style=color:#f92672>()</span>;

  // Reset the loop <span style=color:#66d9ef>if</span> no new card present on the sensor/reader. This saves the entire process when idle.
  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span> ! mfrc522.PICC_IsNewCardPresent<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>return</span>;
  <span style=color:#f92672>}</span>

  // Select one of the cards
  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span> ! mfrc522.PICC_ReadCardSerial<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>return</span>;
  <span style=color:#f92672>}</span>

  // Compute and print UID
  char uid<span style=color:#f92672>[</span>30<span style=color:#f92672>]</span>;
  char * buffer <span style=color:#f92672>=</span> uid;
  <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>byte i <span style=color:#f92672>=</span> 0; i &lt; mfrc522.uid.size; i++<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    int n <span style=color:#f92672>=</span> sprintf<span style=color:#f92672>(</span>buffer, <span style=color:#e6db74>&#34;%s%02x&#34;</span>, i &gt; <span style=color:#ae81ff>0</span> ? <span style=color:#e6db74>&#34;:&#34;</span> : <span style=color:#e6db74>&#34;&#34;</span>, mfrc522.uid.uidByte<span style=color:#f92672>[</span>i<span style=color:#f92672>])</span>;
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>n &gt; 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
      buffer <span style=color:#f92672>+=</span> n;
    <span style=color:#f92672>}</span>
  <span style=color:#f92672>}</span>
  Serial.println<span style=color:#f92672>(</span>uid<span style=color:#f92672>)</span>;
  client.publish<span style=color:#f92672>(</span>mqtt_topic, uid<span style=color:#f92672>)</span>;
  delay<span style=color:#f92672>(</span>500<span style=color:#f92672>)</span>;
<span style=color:#f92672>}</span>
</code></pre></div><h3 id=compile-your-code-1>Compile your code</h3>
<p><img src=/images/platformIO-esp-build.png alt="PlatformIO build"></p>
<h3 id=flash-your-esp8266-with-your-code-1>Flash your ESP8266 with your code</h3>
<p><img src=/images/platformIO-esp-write.png alt="PlatformIO write"></p>
<h3 id=connect-to-your-esp8266-console-1>Connect to your ESP8266 console</h3>
<p><img src=/images/platformIO-esp-console.png alt="PlatformIO console"></p>
<h3 id=result-1>Result</h3>
<p><img src=/images/platformIO-esp-test.png alt="PlatformIO result"></p>
<footer class=footline>
</footer>
</div>
</div>
</div>
<div id=navigation>
<a class="nav nav-prev" href=/mqtt-broker/ title="MQTT Broker"> <i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=/kafka-broker/ title="Kafka Broker" style=margin-right:0><i class="fa fa-chevron-right"></i></a>
</div>
</section>
<div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px>
<div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div>
</div>
<script src=/js/clipboard.min.js?1673368128></script>
<script src=/js/perfect-scrollbar.min.js?1673368128></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1673368128></script>
<script src=/js/jquery.sticky.js?1673368128></script>
<script src=/js/featherlight.min.js?1673368128></script>
<script src=/js/highlight.pack.js?1673368128></script>
<script>hljs.initHighlightingOnLoad()</script>
<script src=/js/modernizr.custom-3.6.0.js?1673368128></script>
<script src=/js/learn.js?1673368128></script>
<script src=/js/hugo-learn.js?1673368128></script>
<script src=/mermaid/mermaid.js?1673368128></script>
<script>mermaid.initialize({startOnLoad:!0})</script>
</body>
</html>